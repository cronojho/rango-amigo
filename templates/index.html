<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa - Rango Amigo</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { padding-top: 56px; }
        @media (min-width: 768px) {
            body { overflow: hidden; }
            .coluna-conteudo { height: calc(100vh - 56px); }
            #map { height: 100%; }
            #lista-doacoes-wrapper { height: 100%; overflow-y: auto; }
        }
        @media (max-width: 767px) {
            #map { height: 50vh; width: 100%; }
            #lista-doacoes-wrapper { height: auto; overflow-y: visible; }
        }
        .doacao-card { cursor: pointer; transition: background-color 0.2s; }
        .doacao-card:hover, .doacao-card:focus { 
            background-color: #f8f9fa; 
            outline: 2px solid #0d6efd;
        }
    </style>
</head>
<body>

    <nav class="navbar bg-white shadow-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('map') }}">Rango Amigo</a>
            <div>
                <span class="navbar-text me-3">
                    Olá, {{ current_user.nome_completo.split(' ')[0] }}
                </span>
                <a href="{{ url_for('postar_page') }}" class="btn btn-success">Cadastrar Doação</a>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger ms-2">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            
            <div class="col-md-7 p-0 coluna-conteudo">
                <div id="map"></div>
            </div>
            
            <div class="col-md-5 coluna-conteudo">
                <div id="lista-doacoes-wrapper" class="p-3">
                    <h2 class="h4 mb-3" aria-label="Lista de Doações Disponíveis">Doações Disponíveis</h2>
                    <div id="lista-doacoes">
                        <p>Carregando doações...</p>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        const coordenadasPederneiras = [-22.35, -48.77]; 
        const map = L.map('map').setView(coordenadasPederneiras, 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const long = pos.coords.longitude;
                L.marker([lat, long]).addTo(map).bindPopup('<b>Você está aqui!</b>').openPopup();
            }, 
            () => { console.log("Não foi possível pegar a localização do usuário."); }
        );

        const marcadores = {};
        
        async function carregarDoacoes() {
            const feed = document.getElementById('lista-doacoes');
            feed.innerHTML = '<p>Carregando...</p>';
            try {
                // API agora usa o link relativo
                const response = await fetch('/api/doacoes'); 
                
                // --- Verificação de Erro (Login Expirado) ---
                if (response.status === 401) { 
                    alert("Sua sessão expirou. Por favor, faça o login novamente.");
                    window.location.href = '/';
                    return;
                }
                if (!response.ok) throw new Error('Falha ao carregar dados da API');
                
                const doacoes = await response.json();
                feed.innerHTML = ''; 

                if (doacoes.length === 0) {
                    feed.innerHTML = '<p class="text-muted">Nenhuma doação cadastrada no momento.</p>';
                    return;
                }

                doacoes.forEach(doacao => {
                    
                    // Constrói o endereço completo
                    let endereco = '';
                    if (doacao.rua) {
                        endereco += `${doacao.rua}, ${doacao.numero || 'S/N'}<br>${doacao.bairro}, ${doacao.cidade}`;
                    } else {
                        endereco = `Coordenadas: ${doacao.latitude.toFixed(4)}, ${doacao.longitude.toFixed(4)}`;
                    }

                    // Atualiza o Popup do Mapa
                    const popupContent = `
                        <b>${doacao.nome_local}</b><br>
                        <small>${endereco}</small><br><br>
                        <strong>Doador:</strong> ${doacao.author_nome}<br>
                        <strong>Itens:</strong> ${doacao.itens}<br>
                        <strong>Retirada:</strong> ${doacao.horario_retirada}
                    `;
                    
                    const marcador = L.marker([doacao.latitude, doacao.longitude])
                        .addTo(map)
                        .bindPopup(popupContent);
                    
                    marcadores[doacao.id] = marcador;
                    
                    // Atualiza o Card da Lista
                    const card = document.createElement('div');
                    card.className = 'card mb-3 doacao-card';
                    card.dataset.doacaoId = doacao.id; 
                    card.setAttribute('role', 'button');
                    card.setAttribute('tabindex', '0');  
                    
                    card.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${doacao.nome_local}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${doacao.bairro || 'Localização via GPS'} - ${doacao.cidade || ''}</h6>
                            <p class="card-text">
                                <strong>Itens:</strong> ${doacao.itens} <br>
                                <strong>Retirada:</strong> ${doacao.horario_retirada}
                            </p>
                            <small class="text-muted">Por: ${doacao.author_nome}</small>
                        </div>
                    `;
                    feed.appendChild(card);
                });
            } catch (error) {
                feed.innerHTML = `<p class="text-danger">Erro ao carregar doações: ${error.message}</p>`;
            }
        }
        
        // Listeners de Clique e Teclado
        document.getElementById('lista-doacoes').addEventListener('click', (e) => {
            const card = e.target.closest('.doacao-card');
            if (card) {
                const id = card.dataset.doacaoId;
                const marcador = marcadores[id];
                if (marcador) {
                    map.flyTo(marcador.getLatLng(), 16);
                    marcador.openPopup();
                }
            }
        });

        document.getElementById('lista-doacoes').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { 
                const card = e.target.closest('.doacao-card');
                if (card) {
                    e.preventDefault(); 
                    card.click(); 
                }
            }
        });

        window.addEventListener('load', carregarDoacoes);
    </script>
</body>
</html>