<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa - Rango Amigo</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { padding-top: 56px; }
        @media (min-width: 768px) {
            body { overflow: hidden; }
            .coluna-conteudo { height: calc(100vh - 56px); }
            #map { height: 100%; }
            #lista-doacoes-wrapper { height: 100%; overflow-y: auto; }
        }
        @media (max-width: 767px) {
            #map { height: 50vh; width: 100%; }
            #lista-doacoes-wrapper { height: auto; overflow-y: visible; }
        }
        .doacao-card { cursor: pointer; transition: background-color 0.2s; }
        .doacao-card:hover, .doacao-card:focus { 
            background-color: #f8f9fa; 
            outline: 2px solid #0d6efd;
        }
    </style>
</head>
<body data-user-id="{{ current_user.id }}">

    <nav class="navbar bg-white shadow-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('map') }}">Rango Amigo</a>
            <div>
                <span class="navbar-text me-3">
                    Olá, {{ current_user.nome_completo.split(' ')[0] }}
                </span>
                <a href="{{ url_for('minhas_doacoes_page') }}" class="btn btn-outline-primary">Minhas Doações</a>
                <a href="{{ url_for('postar_page') }}" class="btn btn-success ms-2">Cadastrar Doação</a>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger ms-2">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-7 p-0 coluna-conteudo">
                <div id="map"></div>
            </div>
            <div class="col-md-5 coluna-conteudo">
                <div id="lista-doacoes-wrapper" class="p-3">
                    <div id="flash-container">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                      {{ message }}
                                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                    </div>
                    <h2 class="h4 mb-3" aria-label="Lista de Doações Disponíveis">Doações Disponíveis</h2>
                    <div id="lista-doacoes">
                        </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto" id="toast-title">Rango Amigo</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- (Inicialização, Mapa, Localização, UserID, Toast - sem alteração) ---
        const coordenadasPederneiras = [-22.35, -48.77]; 
        const map = L.map('map').setView(coordenadasPederneiras, 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        navigator.geolocation.getCurrentPosition(
            (pos) => { L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(map).bindPopup('<b>Você está aqui!</b>').openPopup(); }, 
            () => { console.log("Não foi possível pegar a localização do usuário."); }
        );
        const currentUserId = document.body.dataset.userId;
        const marcadores = {};
        const toastEl = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastEl);
        function showToast(message, title = 'Rango Amigo', type = 'info') {
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-body').innerText = message;
            toastEl.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-info');
            if (type === 'success') toastEl.classList.add('text-bg-success');
            else if (type === 'danger') toastEl.classList.add('text-bg-danger');
            else toastEl.classList.add('text-bg-info');
            toast.show();
        }
        
        async function carregarDoacoes() {
            // (Função carregarDoacoes - sem alteração)
            const feed = document.getElementById('lista-doacoes');
            feed.innerHTML = `<div class="d-flex justify-content-center mt-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>`;
            try {
                const response = await fetch('/api/doacoes'); 
                if (response.status === 401) { 
                    showToast("Sessão expirada. Faça login.", "Erro", "danger");
                    window.location.href = '/';
                    return;
                }
                if (!response.ok) throw new Error('Falha ao carregar dados da API');
                const doacoes = await response.json();
                feed.innerHTML = ''; 
                if (doacoes.length === 0) {
                    feed.innerHTML = '<p class="text-muted">Nenhuma doação cadastrada no momento.</p>';
                    return;
                }
                Object.values(marcadores).forEach(m => m.remove());
                doacoes.forEach(doacao => {
                    let endereco = doacao.rua ? `${doacao.rua}, ${doacao.numero || 'S/N'}<br>${doacao.bairro}, ${doacao.cidade}` : `Coordenadas: ${doacao.latitude.toFixed(4)}, ${doacao.longitude.toFixed(4)}`;
                    let actionButtonHtml = '';
                    if (doacao.user_id == currentUserId) {
                        actionButtonHtml = `<button class="btn btn-warning btn-sm mt-2" onclick="handleArquivar(${doacao.id})">Arquivar</button>`;
                    }
                    const popupContent = `
                        <b>${doacao.nome_local}</b><br>
                        <small>${endereco}</small><br><br>
                        <strong>Doador:</strong> ${doacao.author_nome}<br>
                        <strong>Itens:</strong> ${doacao.itens}<br>
                        <strong>Retirada:</strong> ${doacao.horario_retirada}<br>
                        ${actionButtonHtml}
                    `;
                    const marcador = L.marker([doacao.latitude, doacao.longitude]).addTo(map).bindPopup(popupContent);
                    marcadores[doacao.id] = marcador;
                    const card = document.createElement('div');
                    card.className = 'card mb-3 doacao-card';
                    card.dataset.doacaoId = doacao.id; 
                    card.setAttribute('role', 'button');
                    card.setAttribute('tabindex', '0');  
                    card.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${doacao.nome_local}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${doacao.bairro || 'Localização via GPS'} - ${doacao.cidade || ''}</h6>
                            <p class="card-text">
                                <strong>Itens:</strong> ${doacao.itens} <br>
                                <strong>Retirada:</strong> ${doacao.horario_retirada}
                            </p>
                            <small class="text-muted">Por: ${doacao.author_nome}</small>
                            ${actionButtonHtml}
                        </div>
                    `;
                    feed.appendChild(card);
                });
            } catch (error) {
                feed.innerHTML = `<p class="text-danger">Erro ao carregar doações: ${error.message}</p>`;
            }
        }
        
        // --- FUNÇÃO DE ARQUIVAR (ATUALIZADA) ---
        async function handleArquivar(id) {
            if (!confirm('Tem certeza que deseja ARQUIVAR esta doação? Ela sairá do mapa principal.')) {
                return;
            }
            try {
                const response = await fetch(`/api/doacao/archive/${id}`, {
                    method: 'PATCH',
                });

                if (response.status === 403) throw new Error('Você não tem permissão para arquivar esta doação.');
                if (!response.ok) throw new Error('Falha ao arquivar a doação.');
                
                showToast('Doação arquivada com sucesso!', 'Sucesso', 'success');
                
                // === MUDANÇA AQUI ===
                // Manda o JavaScript recarregar a lista e o mapa
                carregarDoacoes(); 
                
            } catch (error) {
                showToast(error.message, 'Erro', 'danger');
            }
        }
        
        // --- (Listener de Clique e Teclado - sem alteração) ---
        document.getElementById('lista-doacoes').addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-warning')) {
                return; 
            }
            const card = e.target.closest('.doacao-card');
            if (card) {
                const id = card.dataset.doacaoId;
                const marcador = marcadores[id];
                if (marcador) {
                    map.flyTo(marcador.getLatLng(), 16);
                    marcador.openPopup();
                }
            }
        });
        document.getElementById('lista-doacoes').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { 
                if (e.target.classList.contains('btn-warning')) {
                    return;
                }
                const card = e.target.closest('.doacao-card');
                if (card) {
                    e.preventDefault(); 
                    card.click(); 
                }
            }
        });

        window.addEventListener('load', carregarDoacoes);
    </script>
</body>
</html>