<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postar Doa√ß√£o - Rango Amigo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('map') }}">Rango Amigo</a>
            
            <div>
                <span class="navbar-text me-3">
                    Ol√°, {{ current_user.nome_completo.split(' ')[0] }}
                </span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger ms-2">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Cadastrar Nova Doa√ß√£o</h2>
        <form id="form-doacao">
            <div class="mb-3">
                <label for="nome_local" class="form-label">Nome do Estabelecimento</label>
                <input type="text" class="form-control" id="nome_local" required>
            </div>
            <div class="mb-3">
                <label for="itens" class="form-label">Itens para doa√ß√£o</label>
                <textarea class="form-control" id="itens" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label for="horario_retirada" class="form-label">Hor√°rio de Retirada</label>
                <input type="text" class="form-control" id="horario_retirada" required>
            </div>
            <hr>
            <button type="button" class="btn btn-outline-primary mb-3" id="btn-local">
                üìç Usar Minha Localiza√ß√£o Atual
            </button>
            <input type="hidden" id="latitude">
            <input type="hidden" id="longitude">
            <p id="local-status" class="text-muted"></p>
            <button type="submit" class="btn btn-success" id="btn-salvar">Salvar Doa√ß√£o</button>
        </form>
    </div>

    <script>
        document.getElementById('btn-local').addEventListener('click', () => {
            if ("geolocation" in navigator) {
                const status = document.getElementById('local-status');
                status.innerText = "Obtendo localiza√ß√£o...";
                status.className = "text-info";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const long = position.coords.longitude;
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = long;
                        status.innerText = `Localiza√ß√£o obtida com sucesso!`;
                        status.className = "text-success";
                    },
                    (error) => {
                        status.innerText = "Erro ao obter localiza√ß√£o. Por favor, libere a permiss√£o no seu navegador e tente novamente.";
                        status.className = "text-danger";
                    }
                );
            } else {
                alert("Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.");
            }
        });

        document.getElementById('form-doacao').addEventListener('submit', async function(event) {
            event.preventDefault(); 
            const btn = document.getElementById('btn-salvar');
            btn.disabled = true;
            btn.innerText = 'Salvando...';

            const dados = {
                nome_local: document.getElementById('nome_local').value,
                itens: document.getElementById('itens').value,
                horario_retirada: document.getElementById('horario_retirada').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value)
            };
            
            if (!dados.latitude || !dados.longitude) {
                alert("Por favor, clique no bot√£o 'Usar Minha Localiza√ß√£o Atual' antes de salvar.");
                btn.disabled = false;
                btn.innerText = 'Salvar Doa√ß√£o';
                return;
            }

            try {
                const response = await fetch('/api/doacao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                if (!response.ok) {
                    throw new Error('Falha ao salvar. Verifique os dados.');
                }
                alert('Doa√ß√£o cadastrada com sucesso!');
                window.location.href = '/map'; // Volta para o mapa
            } catch (error) {
                alert(`Erro: ${error.message}`);
                btn.disabled = false;
                btn.innerText = 'Salvar Doa√ß√£o';
            }
        });
    </script>
</body>
</html>