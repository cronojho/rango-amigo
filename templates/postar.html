<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postar Doa√ß√£o - Rango Amigo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('map') }}">Rango Amigo</a>
            <div>
                <span class="navbar-text me-3">
                    Ol√°, {{ current_user.nome_completo.split(' ')[0] }}
                </span>
                <a href="{{ url_for('minhas_doacoes_page') }}" class="btn btn-outline-primary">Minhas Doa√ß√µes</a>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger ms-2">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Cadastrar Nova Doa√ß√£o</h2>
        <form id="form-doacao">
            <div class="mb-3">
                <label for="nome_local" class="form-label">Nome do Estabelecimento</label>
                <input type="text" class="form-control" id="nome_local" required>
            </div>
            <div class="mb-3">
                <label for="itens" class="form-label">Itens para doa√ß√£o</label>
                <textarea class="form-control" id="itens" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label for="horario_retirada" class="form-label">Hor√°rio de Retirada</label>
                <input type="text" class="form-control" id="horario_retirada" required>
            </div>
            <hr>
            <h4 class="h5">Endere√ßo da Doa√ß√£o</h4>
            <button type="button" class="btn btn-outline-primary mb-3" id="btn-local" 
                    aria-label="Ativar geolocaliza√ß√£o para usar sua localiza√ß√£o atual">
                üìç Usar Minha Localiza√ß√£o Atual (Se voc√™ estiver no local)
            </button>
            <p class="text-center">-- OU --</p>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="cep" class="form-label">CEP</label>
                    <input type="text" class="form-control" id="cep" placeholder="00000-000">
                </div>
                <div class="col-md-2 align-self-end">
                    <button type="button" class="btn btn-secondary w-100" id="btn-buscar-cep">Buscar</button>
                </div>
                <div class="col-md-6">
                    <label for="rua" class="form-label">Rua / Logradouro</label>
                    <input type="text" class="form-control" id="rua" readonly>
                </div>
                <div class="col-md-4">
                    <label for="numero" class="form-label">N√∫mero</label>
                    <input type="text" class="form-control" id="numero">
                </div>
                <div class="col-md-4">
                    <label for="bairro" class="form-label">Bairro</label>
                    <input type="text" class="form-control" id="bairro" readonly>
                </div>
                <div class="col-md-4">
                    <label for="cidade" class="form-label">Cidade</label>
                    <input type="text" class="form-control" id="cidade" readonly>
                </div>
            </div>
            <input type="hidden" id="latitude">
            <input type="hidden" id="longitude">
            <p id="local-status" class="text-muted mt-3" role="status" aria-live="polite"></p>
            <hr>
            <button type="submit" class="btn btn-success" id="btn-salvar">Salvar Doa√ß√£o</button>
        </form>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- (Fun√ß√£o Toast - sem altera√ß√£o) ---
        const toastEl = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastEl);
        function showToast(message, title = 'Rango Amigo', type = 'info') {
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-body').innerText = message;
            toastEl.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-info');
            if (type === 'success') toastEl.classList.add('text-bg-success');
            else if (type === 'danger') toastEl.classList.add('text-bg-danger');
            else toastEl.classList.add('text-bg-info');
            toast.show();
        }
        
        // --- (L√≥gica do Formul√°rio, GPS, CEP - sem altera√ß√£o) ---
        const statusEl = document.getElementById('local-status');
        const latEl = document.getElementById('latitude');
        const lonEl = document.getElementById('longitude');
        const cepEl = document.getElementById('cep');
        const ruaEl = document.getElementById('rua');
        const bairroEl = document.getElementById('bairro');
        const cidadeEl = document.getElementById('cidade');
        
        document.getElementById('btn-local').addEventListener('click', () => {
            // ... (l√≥gica do gps)
            if ("geolocation" in navigator) {
                statusEl.innerText = "Obtendo localiza√ß√£o...";
                statusEl.className = "text-info mt-3";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        latEl.value = position.coords.latitude;
                        lonEl.value = position.coords.longitude;
                        statusEl.innerText = `Localiza√ß√£o obtida com sucesso! (via GPS)`;
                        statusEl.className = "text-success mt-3";
                        limparCamposCep(false); 
                    },
                    (error) => {
                        statusEl.innerText = "Erro ao obter localiza√ß√£o. Tente novamente.";
                        statusEl.className = "text-danger mt-3";
                    }
                );
            } else {
                showToast("Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.", "Erro", "danger");
            }
        });

        document.getElementById('btn-buscar-cep').addEventListener('click', async () => {
            // ... (l√≥gica do cep)
            const cep = cepEl.value.replace(/\D/g, ''); 
            if (cep.length !== 8) {
                statusEl.innerText = "CEP inv√°lido. Deve conter 8 n√∫meros.";
                statusEl.className = "text-danger mt-3";
                return;
            }
            statusEl.innerText = "Buscando CEP...";
            statusEl.className = "text-info mt-3";
            try {
                const response = await fetch(`https://brasilapi.com.br/api/cep/v2/${cep}`);
                if (!response.ok) throw new Error('CEP n√£o encontrado.');
                const data = await response.json();
                ruaEl.value = data.street;
                bairroEl.value = data.neighborhood;
                cidadeEl.value = data.city;
                if (data.location && data.location.coordinates) {
                    latEl.value = data.location.coordinates.latitude;
                    lonEl.value = data.location.coordinates.longitude;
                    statusEl.innerText = "Endere√ßo encontrado com sucesso! (via CEP)";
                    statusEl.className = "text-success mt-3";
                } else {
                    throw new Error('CEP encontrado, mas sem coordenadas de mapa.');
                }
            } catch (error) {
                statusEl.innerText = error.message;
                statusEl.className = "text-danger mt-3";
                limparCamposCep(true);
            }
        });
        
        function limparCamposCep(manterCep) {
            if (!manterCep) cepEl.value = '';
            ruaEl.value = '';
            bairroEl.value = '';
            cidadeEl.value = '';
        }

        document.getElementById('form-doacao').addEventListener('submit', async function(event) {
            // ... (l√≥gica de envio do form, spinners, etc - sem altera√ß√£o)
            event.preventDefault(); 
            const btn = document.getElementById('btn-salvar');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...`;
            const dados = {
                nome_local: document.getElementById('nome_local').value,
                itens: document.getElementById('itens').value,
                horario_retirada: document.getElementById('horario_retirada').value,
                latitude: parseFloat(latEl.value),
                longitude: parseFloat(lonEl.value),
                cep: cepEl.value,
                rua: ruaEl.value,
                numero: document.getElementById('numero').value,
                bairro: bairroEl.value,
                cidade: cidadeEl.value
            };
            if (!dados.latitude || !dados.longitude) {
                showToast("Por favor, use o bot√£o 'Usar Minha Localiza√ß√£o Atual' ou 'Buscar CEP' antes de salvar.", "Aten√ß√£o", "info");
                btn.disabled = false;
                btn.innerText = 'Salvar Doa√ß√£o';
                return;
            }
            try {
                const response = await fetch('/api/doacao', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                if (response.status === 401) {
                    showToast("Sua sess√£o expirou. Voc√™ ser√° redirecionado para o login.", "Sess√£o Expirada", "danger");
                    setTimeout(() => { window.location.href = '/'; }, 3000); 
                    return;
                }
                if (!response.ok) throw new Error('Falha ao salvar. Verifique os dados.');
                
                showToast('Doa√ß√£o cadastrada com sucesso! Redirecionando...', 'Sucesso!', 'success');
                setTimeout(() => { window.location.href = '/map'; }, 2000); 
            } catch (error) {
                showToast(`Erro: ${error.message}`, "Erro ao Salvar", "danger");
                btn.disabled = false;
                btn.innerText = 'Salvar Doa√ß√£o';
            }
        });
    </script>
</body>
</html>