<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postar Doa√ß√£o - Rango Amigo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar bg-white shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Rango Amigo</span>
            <a href="index.html" class="btn btn-outline-secondary">Voltar ao Feed</a>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Cadastrar Nova Doa√ß√£o</h2>
        <form id="form-doacao">
            <div class="mb-3">
                <label for="nome_local" class="form-label">Nome do Estabelecimento</label>
                <input type="text" class="form-control" id="nome_local" required>
            </div>
            <div class="mb-3">
                <label for="itens" class="form-label">Itens para doa√ß√£o</label>
                <textarea class="form-control" id="itens" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label for="horario_retirada" class="form-label">Hor√°rio de Retirada</label>
                <input type="text" class="form-control" id="horario_retirada" required>
            </div>
            
            <hr>

            <button type="button" class="btn btn-outline-primary mb-3" id="btn-local">
                üìç Usar Minha Localiza√ß√£o Atual
            </button>
            
            <input type="hidden" id="latitude">
            <input type="hidden" id="longitude">
            
            <p id="local-status" class="text-muted"></p>
            
            <button type="submit" class="btn btn-success" id="btn-salvar">Salvar Doa√ß√£o</button>
        </form>
    </div>

    <script>
        // --- SCRIPT NOVO PARA GEOLOCALIZA√á√ÉO ---
        document.getElementById('btn-local').addEventListener('click', () => {
            if ("geolocation" in navigator) {
                const status = document.getElementById('local-status');
                status.innerText = "Obtendo localiza√ß√£o...";
                status.className = "text-info"; // Muda a cor para azul

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Sucesso!
                        const lat = position.coords.latitude;
                        const long = position.coords.longitude;
                        
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = long;
                        
                        status.innerText = `Localiza√ß√£o obtida com sucesso!`;
                        status.className = "text-success"; // Muda a cor para verde
                    },
                    (error) => {
                        // Erro!
                        status.innerText = "Erro ao obter localiza√ß√£o. Por favor, libere a permiss√£o no seu navegador e tente novamente.";
                        status.className = "text-danger"; // Muda a cor para vermelho
                    }
                );
            } else {
                alert("Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.");
            }
        });


        // --- SCRIPT ATUALIZADO PARA ENVIAR O FORMUL√ÅRIO ---
        document.getElementById('form-doacao').addEventListener('submit', async function(event) {
            event.preventDefault(); // Impede o envio padr√£o

            const btn = document.getElementById('btn-salvar');
            btn.disabled = true;
            btn.innerText = 'Salvando...';

            // 1. Coletar os dados do formul√°rio
            const dados = {
                nome_local: document.getElementById('nome_local').value,
                itens: document.getElementById('itens').value,
                horario_retirada: document.getElementById('horario_retirada').value,
                // --- CAMPOS NOVOS ---
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value)
            };
            
            // Verifica√ß√£o simples se a localiza√ß√£o foi obtida
            if (!dados.latitude || !dados.longitude) {
                alert("Por favor, clique no bot√£o 'Usar Minha Localiza√ß√£o Atual' antes de salvar.");
                btn.disabled = false;
                btn.innerText = 'Salvar Doa√ß√£o';
                return; // Para a execu√ß√£o do salvamento
            }

            try {
                // 2. Enviar os dados para a API Flask (POST)
                const response = await fetch('http://127.0.0.1:5000/api/doacao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    throw new Error('Falha ao salvar. Verifique os dados.');
                }

                alert('Doa√ß√£o cadastrada com sucesso!');
                window.location.href = 'index.html'; // Volta para o feed

            } catch (error) {
                alert(`Erro: ${error.message}`);
                btn.disabled = false;
                btn.innerText = 'Salvar Doa√ß√£o';
            }
        });
    </script>
</body>
</html>